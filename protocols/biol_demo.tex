\subsection{tau187 $T_{1,0}$ sample}\label{sec:biol_tau_unlabeled}
\timeblockstart
\timeblocktotal{3.6}
This is the protocol

\subsubsection{initial setup}\maxminutes{57}
\paragraph{before leaving}
Be sure to carry over:
\begin{itemize}
    \item microcentrifuge tubes
    \item toolbox 
    \item multimeter 
    \item samples (leave in my box in CNSI fridge)
    \item magnifying glasses
\end{itemize}

\paragraph{always}
Be sure to change section title and label!!!

Copy section label to list for the day.

\paragraph{On + set up for (first exp only)}
\precaution{Check that copper plate is set up}

EPR and source on, magnet and air off.

Be sure mod coil is hooked up, and the waveguide switch is set to ESR.

Remove top collets on dewar.

Take box around back.

Remove dewar.

Insert air tube (put only bottom collet on, tighten very loosely, then add and tighten top collet).

Zip tie air tube.

Attach tuning box to plate.

Wait until bridge stops flashing, then open WinEPR + switch to tune mode 40~dB.

Find dip near 9.8~GHz.

\paragraph{load sample}
Put spectrometer into tune mode, and turn down power.

Load 3.5\uL of sample.

Press twice in critoseal.

Score other end very lightly.

Break + press twice in semi-soft (clay consistency) wax.

Melt wax.

Clean w/ razor.

Inspect + measure\sout{ with magnifying glasses}.

Put into tune mode before inserting sample, and turn down power.

Insert probe, and turn up air to \sout{12~SCFH}14~SCFH (which is what I have been using) (since a new sample, just use a higher flow rate).

Move to near 9.77 and autotune.

\subsubsection{Quick ESR in probe}\maxminutes{11}
\paragraph{test for signal}
Open an old experiment.

Copy.

Try to increase the modulation amplitude, just to see signal.

zoom in and repeat.

Check for saturation starting from 15, down by 3~dB.

Save saturated scan.
\fn{tau_overmod_sat_120329}

Use a power slightly before saturation.

Make an experiment with this power, but turn down the modulation amplitude and change the receiver window and the resolution and number of scans.

\paragraph{actual ESR}
Turn on field.

Copy experiment.
\fn{tau_120329.par}

\paragraph{always}
Run actual scan.

Save ESR.
\fn{tau_120329}

Cntrl-S after scan is finished.

Hit Cntrl-A for ssh transfer and process.


\begin{tiny}
\begin{lstlisting}
fl = figlistl()
standard_epr(dir = DATADIR+'cnsi_data',
    files = ['tau_120329'],
    background = 'tau_nl_120329',
    figure_list = fl)
fl.show(thisjobname()+'.pdf')
\end{lstlisting}
\end{tiny}

\subsubsection{set up DNP}\maxminutes{38}
\paragraph{determine ratio (if desired)}

\subparagraph{determine experimentally}
Re-run ESR with probe.

Copy template.
\fn{tau_120329}

\sout{ Wobb + just set sfo1 to bottom of dip. }
sfo1 to 1.51671*frequency, regardless of exact nucleus.
wobb + tune NMR.

Tune EPR.

Unclick g=2, and set mod amp high so I can get signal in a signal shot.

Re-run EPR zoomed in to center peak.

Turn modulation amp down to 0.3~G, and let it run a few averages.

Set offset based on high and low peaks.
\fn{tau_findfield_120329}

Set field to zero-crossing of center peak on EPR.

Set EPR to standby.

jf\_zg.

Unplug mod coil.

Set sfo1 to resonance.

Increase aq to 2.0.  

jf\_zg and lightning bolt for o1.  

jf\_zg to check.

Copy microwave frequency from ESR and sfo1 from center frequency.  


\begin{lstlisting}
microwave_frequency = 9.789871 #(from file)
field = 3488.66
nmr_frequency = 14.8497568
field = field * 1e-4
chemical = 'mtsl'
#obs('previous:')
#calcfielddata(microwave_frequency,chemical,'cnsi')
obs('new:')
save_data({chemical+'_elratiocnsi':microwave_frequency/field})
save_data({chemical+'_nmrelratio':nmr_frequency/microwave_frequency})
calcfielddata(microwave_frequency,chemical,'cnsi')
\end{lstlisting}


Set \texttt{aq} back to 0.5.

\paragraph{Tune and set resonant field}
Detach mod coil and hang in the plastic loop (here so that I don't potentially mess up microwave tune later!).

Copy nmr template dataset.
\fn{dna_cs14_bound_120314}

Overwrite exp 1 with desired parameters.
\fn{dna_cs14_rerun_120314}

Round nearest 0.0005\GHz to get YIG frequency.

Open first NMR experiment in Topspin.

\precaution{If a different frequency or label than usual, set NMR sfo1 to (ratio)*(YIG frequency).}
Tune NMR with {\tt wobb} (type {\tt stop} when done).

\precaution{Run jf\_dnpconf if necessary -- specifically may need to decrease my attenuation settings by 2.7 $dB$ (or just round it to 3 $dB$).}

Tune microwave by hand
{\small (Simultaneously set:
\begin{itemize}
    \item bias (diode centered at 50 $dB$)
    \item frequency (AFC)
    \item phase (coarse: dip in tune mode; fine: furthest right diode w.r.t.signal phase while AFC remains locked)
    \item iris (diode centered at all powers) 
\end{itemize}
up to 5 $dB$.)}
\begin{lstlisting}
calcfielddata(9.789519,'mtsl','cnsi')
\end{lstlisting}

Check that YIG frequency is still good

EPR to standby.

\paragraph{ Match NMR + YIG frequencies}
\precaution{If frequency is really different for some reason, I will have to set the field here to the value given above.}
Set static field.

jf\_zg $\Rightarrow$ for 3.5 $\mu L$ sample, peak should 10-15 high.

Check that the source is on, and reads 0.26 $A$ (rather than 0.54 $A$).

Click lightning bolt to set o1 (while zoomed in with top window).

Set YIG frequency with \texttt{jf\_setmw}.

Be sure the ppt value is set to the value above.

Open \texttt{gs}, click the checkbox on top, and set phase correction mode do pk. 

\precaution{If gs shows an FID, then click the button on top to get FT.}
\precaution{Test amp switch with jf\_setmw (leave other parameters as default).}
Iteratively adjust the field.
{\small
\begin{enumerate}
    \item slide slider so peak is on average at 0. 
    \item click save. 
	\item jf\_setmw (31.5 $dB$, YIG frequency),
	\item then if field offset is significant, adjust $B_0$, otherwise stop
	\item jf\_zg
\end{enumerate}
}

Since the gs procedure is new,
run jf\_zg to check that the peak is roughly centered,
and also re-run jf\_setmw to check that it
reads the same number as the last go above.

\paragraph{90 time and ready amp}
{\tt jf\_zg} + zoom + {\tt dpl1} + run {\tt paropt} (p1,8,1,3)

\precaution{This should go down to up at the full cycle;
if problems, (p1,1,1,11).}
\precaution{If you want to decrease the narrow noise spikes, minimize WinEPR + turn off bridge + put all bridge cables on top of dewar while paropt is running; could be obsolete with box?}
Flip waveguide switch.

Set + record $t_{90}$ (``\texttt{p1}'')=(length of full cycle [\us])/4 (At this point, you've determined the resonance frequency, resonant field, and $t_{90}$).

\paragraph{Estimate $T_1$ (with heating)}

\subparagraph{Estimate based on concentration {\tiny (if $T_1$ is available for a different concentration)}}

\begin{lstlisting}
# edit following
oldconc = 2e-3 # set this to None if oldt1 is given at
#the same concentration
oldt1 = 0.89
newconc = 10e-6
# leave the following alone
def estimate_t1(concentration,value,newconc):
    water = 1./2.6
    relaxivity = 1./value
    relaxivity -= water
    relaxivity /= concentration
    relaxivity *= newconc
    relaxivity += water
    return 1./relaxivity
def estimate_hot_t1(thist1):
    water = 1./2.6
    hot_water = 1./3.65 # this is for the
    #new ``closed'' type probe # 7/8 adjusted this
    thist1 = 1./thist1 # convert to a rate
    thist1 -= water # figure out which part
    #is from water
    thist1 += hot_water # add back in for heating
    return 1./thist1
if oldconc == None:
    t1 = oldt1
else:
    t1 = estimate_t1(oldconc,oldt1,newconc)
    obs(dp(t1,2),r' $s$ without heating')
obs(dp(estimate_hot_t1(t1),2),r' $s$ with heating')
\end{lstlisting}

\subparagraph{Estimate experimentally (from rough measurement of $T_1$ and known heating)}

\texttt{re 1 1}

\texttt{jf\_t10} with default parameters (should be min 1,max 3,steps 5,min ratio 0.08 (should have been 0.05 to match), max ratio 4, pull from exp 4, put in exp 101).

Copy the nmr data.

Change file name!

Process the $T_1$


\begin{scriptsize}
\begin{lstlisting}
# these change
name = 'tau_120329'
path = DATADIR+'cnsi_data/'
# the following stays the same
dnp_for_rho(path,name,[],expno=[],t1expnos = [101],
        integration_width = 150,peak_within = 500,
        show_t1_raw = True,phnum = [4],
        phchannel = [-1],
        h5file='t1_estimation_only.h5',
        pdfstring = name,
        clear_nodes=True)
t1 = retrieve_T1series('t1_estimation_only.h5',name)
def estimate_hot_t1(thist1):
    water = 1./2.6
    hot_water = 1./3.8 # this is for the new ``closed''
    #type probe # 7/8 adjustted this
    thist1 = 1./thist1 # convert to a rate
    thist1 -= water # figure out which part is from
    #water
    thist1 += hot_water # add back in for heating
    return 1./thist1
obs(r'Min $T_1\approx$',lsafe(t1['power',0]),r'\quad $T_{1,max}\approx$',
        lsafe(estimate_hot_t1(t1)),
        r' $s$ with heating')
\end{lstlisting}
\end{scriptsize}

\paragraph{determine $T_1(t)$}
Use jf\_dnp to determine number of points for a scan \sout{17~min}12~min long:
tau187 nl $\Rightarrow$ min of 2.1 max of 2.2

Run jf\_t10s:
Set \sout{ 20 }10 experiments for \sout{ 4:40 }\add{2:50}, exp 4$\Rightarrow$ 501.

Come back after it ran.

\paragraph{run DNP}
Start jf\_dnp: Set minimum and maximum $T_1$ values based on $T_1$ estimate (with heating).
tau187 $\Rightarrow$ min 1.8, max 2.4
tau187 nl $\Rightarrow$ min of 2.1 max of 3.0

Set number of $T_1$ time to \sout{17~min}12~min for this sample.

Set watch timer for experiment time.

\nts{consider closing and opening FTDI connection in the code, so the lock check works!}
\subsubsection{wait for DNP to run}\maxminutes{90}

\subsubsection{process + put back system}\maxminutes{6}
\paragraph{process DNP}
Transfer NMR files.

Change name, chemical names, concentration, and run number.

For $T_{1,0}$, set dontfit to True, otherwise False.

\nts{why does the $T_{1,0}$ have a concentration, since it will always be 0?}
Run processing.

Mask/unmask $T_1$'s as necessary.

\nts{in the new version, I should really set it up so that it automatically takes care of both the auto steps for $T_1$ and the $T_1$ mask!, and also checks that the max $T_1$ is OK!!!}
Check that my longest $T_1$ falls within range.

Add to the compilation, to see how the data looks.

Check the consistency of the enhancements with decreasing power.

Redo experiment 5 as 505 \texttt{re 5 1;Ctrl-N} + enter exp 505 +\texttt{zg}.

Comment {\tt search\_delete\_datanode}.

\nts{should actually be able to get rid of the guessing problem by switching it to guess with the pseudoinverse!}

\begin{scriptsize}
\begin{lstlisting}
import textwrap
name = 'tau_120330'
chemical_name = 'tau187'
run_number = 120330
concentration = 600e-6
dontfit = False
# the following stays the same
path = DATADIR+'franck_cnsi/nmr'
search_delete_datanode('dnp.h5',name)
# leave the rest of the code relatively consistent
#{{{ generate the powers for the T1 series
print 'First, check the $T_1$ powers:\n\n'
fl = []
t1_dbm,fl = auto_steps(path+name+'/t1_powers.mat',
    threshold = -35,t_minlength = 5.0*60,
    t_maxlen = 40*60, t_start = 4.9*60.,
    t_stop = inf,first_figure = fl)
print r't1\_dbm is:',lsafen(t1_dbm)
lplotfigures(fl,'t1series_'+name)
print '\n\n'
t1mask = bool8(ones(len(t1_dbm)))
# the next line will turn off select (noisy T1
# outputs) enter the number of the scan to remove --
# don't include power off
t1mask[-1] = 0
#}}}
dnp_for_rho(path,name,integration_width = 160,
        peak_within = 500, show_t1_raw = True,
        phnum = [4],phchannel = [-1],
        t1_autovals = r_[2:2+len(t1_dbm)][t1mask],
        t1_powers = r_[t1_dbm[t1mask],-999.],
        power_file = name+'/power.mat',t_start = 4.6,
        chemical = chemical_name,
        concentration = concentration,
        extra_time = 6.0,
        dontfit = dontfit,
        run_number = run_number,
        threshold = -50.)
standard_noise_comparison(name)
# tried to fix error on cov more fix more fix more fix more fix more fix
\end{lstlisting}
\end{scriptsize}

\ntd{Here, I should be sure I'm including time for the 3 scans in addition to the ones that are counted.}
\paragraph{Process multiple $T_1$ data}
Copy (or Git once that's ready) files.

Change all parameters at beginning.

Run script

\begin{scriptsize}
\begin{lstlisting}
# these change
name = 'tau_nl_120330'
chemical = 'tau187'
concentration = 0.0
run_number = 120330
number_of_repeats = 7
start_exp = 101
# everything else stays the same
path = DATADIR+'franck_cnsi/nmr/'
dnp_for_rho(path,name,[],expno=[],
    t1expnos = r_[start_exp:start_exp+number_of_repeats],
    integration_width = 150,peak_within = 500,
    show_t1_raw = True,phnum = [4],
    phchannel = [-1],
    chemical = chemical,
    concentration = concentration,
    run_number = run_number,
    h5file='dnp.h5',
    pdfstring = name,
    clear_nodes = False)
t1 = retrieve_T1series('dnp.h5',
    name,
    chemical,
    concentration)
t1.rename('power','expno')
t1.labels('expno',r_[1:1+number_of_repeats])
plot(t1)
lplot(name+'_t1_vs_time.pdf')
\end{lstlisting}
\end{scriptsize}
\paragraph{put back system}
\subparagraph{Always}
Field off.

Hook up mod coil.

Flip back ESR switch.

Turn off the air + check rate.

Pull out + inspect + measure sample with magnifying glasses.

\subsubsection{ESR}\maxminutes{11}

(Here, I run ESR after the DNP, so I don't have to worry about timing, but still get the double integral)
Put into tune mode, $40\;dB$ first.

Load sample in the teflon sample holder (I want ~77 $mm$ from collet to bottom of sample, need to remeasure) -- weight the top with the collet holder.

Move to near 9.77 and autotune.

Open ESR parameter set similar to this one.
\fn{grocomplex_120202.par}

Turn on field.

Copy experiment.

If not exactly the same type of sample, test run to check some stuff.

\precaution{Only if the experiment says ``uncalibrated'' at the top $\Rightarrow$ ``I'' (interactive spectrometer control) icon, click calibrated, then set parameters to spectrum, then window.}

\paragraph{if new type of sample}
Stop at second peak.

Check that modulation amplitude is $<$ 0.2 x smallest feature.

Set RG with box.

Check that resolution along $x$ is OK.

\paragraph{always}

Run actual scan.

Save ESR.
\fn{groes_120202}

For 8 scans, alarm for about 2.5 min.

Cntrl-S after scan is finished.

Hit Cntrl-A for ssh transfer and process.


\begin{tiny}
\begin{lstlisting}
fl = figlistl()
standard_epr(dir = DATADIR+'franck_cnsi',
    files = ['tau_likeanna2_120330',
        r'500uM100%label18kdaBeforeHeparin031308'],
    figure_list = fl)
fl.show(thisjobname()+'.pdf')
\end{lstlisting}
\end{tiny}

Put into tune mode before removing sample, and turn down power.

Run background scan.

\subsubsection{wrap up}\maxminutes{18}
git commit, then copy working copy of notebook into compilation.

Clear + copy to protocol.

\subparagraph{Run ESR background scan}
Autotune + run ESR background scan.

\subparagraph{Last experiment only}
If done, remove air tube.

Unscrew top collet + carry box w/ dewar around to back.

Remove glass tube and replace dewar.

Insert inner collet.

Screw down top collet holder.

Cap cavity.

Tell software that bridge is on + switch to tune mode

Check for dip near 9.88~GHz (if without dewar) or 9.31~GHz (if with dewar).

Autotune + record Q.

Remove tuning box.

If done, magnet off, ESR off, chiller off, source output off.

Be sure to take coolers and dewar back to lab.

\timeblockend
